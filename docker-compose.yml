services:
  db:
    image: postgres:16
    container_name: edu_db
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: unless-stopped

  api:
    build:
      context: ./API
    container_name: edu_api
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080

      ConnectionStrings__DefaultConnection: Host=db;Port=5432;Database=${POSTGRES_DB};Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD};Pooling=true

      # JWT
      Jwt__Key: ${JWT_KEY}
      Jwt__Issuer: ${JWT_ISSUER}
      Jwt__Audience: ${JWT_AUDIENCE}
      Jwt__ExpiresMinutes: ${JWT_EXPIRES_MINUTES}

      # Seed Admin
      SeedAdmin__Email: ${SEED_ADMIN_EMAIL}
      SeedAdmin__Password: ${SEED_ADMIN_PASSWORD}
      SeedAdmin__Name: ${SEED_ADMIN_NAME}
      SeedAdmin__Surname: ${SEED_ADMIN_SURNAME}

      # ✅ Gemini key (ASP.NET Core config binding)
      Gemini__ApiKey: ${GEMINI_API_KEY}

    # ✅ Runtime verileri korumak için (AI docs + wwwroot uploads)
    volumes:
      - api_uploads:/app/uploads
      - api_wwwroot_uploads:/app/wwwroot/uploads

    depends_on:
      - db
    expose:
      - "8080"
    restart: unless-stopped

  web:
    build:
      context: ./Client
      args:
        VITE_API_URL: /api
    container_name: edu_web
    depends_on:
      - api
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
    restart: unless-stopped

volumes:
  pgdata: {}
  api_uploads: {}          # ✅ /app/uploads  (AI docs: uploads/ai_docs)
  api_wwwroot_uploads: {}  # ✅ /app/wwwroot/uploads (görseller/diğer uploadlar)